<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Omada Voucher Portal</title>
</head>
<body>
    <h1>Omada Voucher Login</h1>
    <button id="executeButton">Execute Requests</button>
    <div id="message"></div>
    <pre id="debug"></pre>

    <script>
        function debug(message) {
            const debugDiv = document.getElementById('debug');
            debugDiv.textContent += message + "\n";
        }

        async function login() {
            debug("Starting login...");
            const response = await fetch('https://192.168.0.50:443/openapi/authorize/login?client_id=e9268e9afe6e49fb83a2140a14834a66&omadac_id=2b620cc1a125dfb76ddbad7be8299745', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    username: 'obordoreynel@gmail.com',
                    password: 'Gofuckyourself123***'
                })
            });
            const data = await response.json();
            debug("Login successful: " + JSON.stringify(data));
            return data.result;
        }

        async function getAuthCode(csrfToken, sessionId) {
            debug("Getting authorization code...");
            const response = await fetch('https://192.168.0.50:443/openapi/authorize/code?client_id=e9268e9afe6e49fb83a2140a14834a66&omadac_id=2b620cc1a125dfb76ddbad7be8299745&response_type=code', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Csrf-Token': csrfToken,
                    'Cookie': 'TPOMADA_SESSIONID=' + sessionId
                }
            });
            const data = await response.json();
            debug("Authorization code received: " + JSON.stringify(data));
            return data.result;
        }

        async function getToken(authCode) {
            debug("Getting access token...");
            const response = await fetch('https://192.168.0.50:443/openapi/authorize/token?grant_type=authorization_code&code=' + authCode, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    client_id: 'e9268e9afe6e49fb83a2140a14834a66',
                    client_secret: '1e62f55a982944fe85dd6fd71d17a0a2'
                })
            });
            const data = await response.json();
            debug("Access token received: " + JSON.stringify(data));
            return data.result;
        }

        async function getVoucher(accessToken) {
            debug("Getting voucher...");
            const response = await fetch(`https://192.168.0.50:443/openapi/v1/2b620cc1a125dfb76ddbad7be8299745/sites/65571f8a7fb7c35166104d8b/hotspot/authed-records?page=1&pageSize=10&searchKey=813751`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'AccessToken=' + accessToken
                }
            });
            const data = await response.json();
            debug("Voucher data received: " + JSON.stringify(data));
            return data;
        }

        document.getElementById('executeButton').addEventListener('click', async function() {
            try {
                const loginResult = await login();
                const authCode = await getAuthCode(loginResult.csrfToken, loginResult.sessionId);
                const tokenResult = await getToken(authCode);
                const voucherData = await getVoucher(tokenResult.accessToken);
                document.getElementById('message').textContent = JSON.stringify(voucherData, null, 2);
            } catch (error) {
                document.getElementById('message').textContent = 'Error: ' + error.message;
                debug("Error: " + error.message);
            }
        });
    </script>
</body>
</html>
